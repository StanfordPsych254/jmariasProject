---
title: "Wang et al. 2015 Replication Report"
author: "Juan Miguel Arias"
date: "March 10, 2016"
output: html_document
---

Replication of Study 2 in "Is Math Anxiety Always Bad for Math Learning? The Role of Math Motivation" by Wang, Z., Lukowski, S.L., Hart, S.A., Lyons, I.M., Thompson, L.A., Kovas, Y., Mazzocco, M.M., Plomin, R. & Petrill, S.A. (2015, Psychological Science)

Replication Author: Juan Miguel Arias

Course Instructors: Dr. Michael Frank, Robert Hawkins, & Eric Smith

Contact information: email: stanfordpsych254 (at) gmail (dot) com

Testable Replication Experiment Webpage:
https://web.stanford.edu/~jmarias/jmariasProject/experiment/mathmotivationsurveys.html


Link to Original Study (Wang et al., 2015) PDF:
http://pss.sagepub.com/content/early/2015/10/30/0956797615602471.full.pdf+html


```{r load packages, echo=F, results='hide', warning=FALSE, message=FALSE}

library(tidyr)
library(plyr)
library(dplyr)
library(psych)
library(ggplot2)
library(Hmisc)
library(xtable)
library(knitr)
library(rjson)
library(tidyjson)

setwd("~/1. STANFORD/2nd Year 15-16/Psych254 Replication Methods/Psych254 Project")
getwd()

```


### Introduction

The study presented here attempts to replicate the findings of Study 2 in Wang et al. (2015), which demonstrated that the relationship between math anxiety and math performance follows an inverted-U pattern among college undergraduate students with higher intrinsic math motivation, whereas this same relationship is linearly negative among students with lower intrinsic math motivation. The current study attempts to replicate and expand this finding using a broader participant pool obtained using Amazon's Mechanical Turk platform. 



### Method

##### Power Analysis

Original test: F-test: multiple, fixed-effects regression with 9 total predictors and one observed predictor for change in R-squared. 

Original effect size: total R-squared: .16 ; change in R-squared for variable of interest (interaction of math anxiety squared and math motivation): .02.

Power analysis: For an effect size of .02 from the above F-test with 219 participants and an alpha of .05, the estimated power achieved is:  55% 

Sample Size needed to achieve 80% power (assuming same effect size): 395
Sample Size needed to achieve 90% power: 528
Sample Size needed to achieve 95% power: 652
Considerations of feasibility for selecting planned sample size.

Planned Sample
	The planned sample will be 395 adult participants recruited from Amazon's Mechanical Turk platform. Study 2 of Wang et al. (2015) used 237 undergraduate students, 56% female, mean age = 19.53 years old (*SD* = 2.01, range = 18 - 39), for their participant sample.
	

#### Materials
  
Please see below for quoted descriptions of the materials used in the original study, which are also used in the present replication: 

>  Participants self-reported math anxiety using the brief version of the Mathematics Anxiety Rating Scale (MARS-B; Suinn & Winston, 2003). The 30-item MARS-B is widely used to measure math anxiety in adults. Items are rated on a 5-point Likert-type scale (1 = not at all nervous, 5 = very very nervous). The MARS-B has excellent internal consistency (Cronbach's alpha = .94). 

> The trait subscale from the State-Trait Anxiety Inventory (Spielberger, 1983) was used to measure participants' general anxiety. This subscale consists of 20 items that are rated on a 4-point Likert-type scale (1 = almost never, 4 = almost always). This scale has excellent internal consistency (Cronbach's alpha = .94). 

> Participants self-reported their math motivation using the same three items from the scale used in Study 1 (M. M. Chiu and Zeng, 2008). The Cronbach's alpha for this scale is .82, which indicates good internal consistency. 

> The problem-verification task (Rinne & Mazzocco, 2014) was used to measure participants' math calculation fluency. Because the 64 easy items were far too easy for undergraduate students (mean accuracy = .93, SD = .06), we chose to focus on the 24 hard items. The hard items had wider performance variability (mean accuracy = .85, SD = .13) and were therefore a more proper measure of individual differences in calculation fluency in college students. An efficiency score was obtained by dividing the percentage of total correct responses by the mean reaction time across all items.

#### *Replication differences of note*
Materials:
The key differences between the original study and the current replication is that the surveys and the measure of math performance (the Problem-Verification Task), were presented to participants as a webpage, direct from the MTurk interface, rather than as a Qualtrics survey.

Another difference: the PVT questions do not include the additional selection choices of "How sure are you of this answer? ('positively sure', 'kind of sure', or 'not sure')", as these selections were not used in the PVT efficiency calculation or later analyses in this particular study. 


#### Procedure
	Note: Block quote below is from Study 1 of same article, replicated in Study 2 and used to describe math performance task procedure
	
>  The problem-verification task was developed as a measure of calculation fluency and metacognition (Rinne & Mazzocco, 2014). We relied on the calculation-fluency component of this measure in the present study. On a laptop, participants were shown a series of two-operand arithmetic problems involving addition, subtraction, multiplication, division, and equivalency of fractions. For each arithmetic problem, a solution was shown that was correct or incorrect, and participants were asked to answer "right," "wrong," or "don't know" as quickly as possible without calculating. Participants were also asked to indicate whether they were "positively sure," "kind of sure," or "not sure" of their answer after each item. Each item was presented for a maximum of 10 s. If no response was given within that time, the program proceeded to the next item.
	In total, participants were given 4 practice items followed by 88 test items. Among all test items, 64 were easy (e.g., single-digit arithmetic, common-denominator fraction, and solutions far from the correct answer), and 24 were hard (e.g., double-digit arithmetic, uncommon- denominator fraction, and solutions close to the correct answer). Reaction time (in seconds) was defined as the time between stimulus onset and response. For the current analyses, an efficiency score was calculated by dividing the percentage of total correct responses by the mean reaction time across all items.
	
	
#### Analysis Plan

>	Hierarchical regression analysis was used to examine whether the quadratic relation between math anxiety and math cognition was further moderated by math motivation. Specifically, performance on the problem- verification task was predicted in four steps. In Step 1, covariates including age, sex, and linear and quadratic terms of general anxiety were entered. The linear term of math motivation and math anxiety was entered in Step 2. In Step 3, we entered the quadratic term of math anxiety and the interaction between math anxiety and math motivation. Finally, we entered the moderated quadratic interaction term between math anxiety and math motivation in Step 4. Math anxiety, math motivation, and general anxiety were standardized and centered prior to analyses in order to compute the interaction and higher-order terms. The outcome variable was also standardized to maintain consistency across the two studies.
 
>  Overall, age and sex both negatively predicted task performance, which indicates that younger and male participants performed better on average than older and female participants, with a larger effect size for sex than for age. General anxiety did not predict math performance. Math anxiety negatively predicted math performance after we controlled for the effects of the covariates. Finally, after controlling for all the linear and two-way interaction effects, we found that the moderated quadratic interaction between math anxiety and math motivation was statistically significant and added incremental predictive effects on math performance.
  To further examine the moderated quadratic effects, we conducted post hoc analyses on the predictive effects of math anxiety at different levels of math anxiety and math motivation using the same procedures as in Study 1*. Results are shown in Table 10 and Figure 3. The findings were consistent with the results from Study 1. At low levels of math motivation, math anxiety was modestly negatively associated with task performance across all levels of math anxiety. At high levels of math motivation, there was an inverted-U curvilinear relation between math anxiety and math performance.
	
> *From Study 1: To further examine the four significant moderated
quadratic effects, we recentered math motivation at low (i.e., 1 SD below the mean) and high (i.e., 1 SD above the mean) levels to examine the relations between math anx- iety and math performance across a wide range of math anxiety (3 SD, 2 SD, and 1 SD above and below the mean as well as at the mean) at these two different levels of math motivation (Aiken & West, 1991).

#### Differences from Original Study

(Post Data Collection) Methods Addendum

##### Actual Sample
	sample size, demographics, data exclusions based on rules spelled out in analysis plan

##### Differences from pre-data collection methods plan
	Any differences from what was described as the original plan, or "none".


### Results

#### Data preparation
	Data preparation following the analysis plan.

```{r clearing environment setting themes, echo=F, results='hide', warnings=F}

# Clearing the global environment
rm(list = ls()) 
ls()

## setting style element for ggplot2
theme_set(theme_bw())

```
	
```{r loading data from mturk json, warning=FALSE}


#Reading the path
path <- "C:\\Users\\Juan\\Documents\\1. STANFORD\\2nd Year 15-16\\Psych254 Replication Methods\\Psych254 Project\\Psych254proj_mturk_DONTCOMMIT\\"
files <- dir(paste0(path,"sandbox-results\\"), 
             pattern = "*.json")
d <- data.frame()

#Transforming data from JSON format to dataframe


#reading the json files and turning them into one data.frame
for (f in files) {
  jf <- paste0(path, "sandbox-results\\",f)
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  id <- data.frame(workerid = jd$WorkerId,
                   accepttime = as.character(jd$AcceptTime),
                   submittime = as.character(jd$SubmitTime),
                   trial_number = as.factor(jd$answers$data$trial_number),
                   block_number = as.factor(jd$answers$data$block_number),
                   trial_type = as.factor(jd$answers$data$trial_type),
                   stimulus = jd$answers$data$stimulus,
                   rating_raw = jd$answers$data$rating,
                   RT = as.numeric(jd$answers$data$rt),
                   ladder = as.numeric(jd$answers$data$ladder),
                   age = jd$answers$data$age,
                   gender = jd$answers$data$gender,
                   education = as.factor(jd$answers$data$education),
                   student = as.factor(jd$answers$data$student),
                   homelang = as.character(jd$answers$data$homelang),
                   ethnicity = jd$answers$data$ethnicity,
                   race = jd$answers$data$race,
                   children = as.factor(jd$answers$data$children),
                   mathhwhelp = as.factor(jd$answers$data$mathhwhelp),
                   childAgeOld = as.factor(jd$answers$data$childAgeOld),
                   expt_aim = jd$answers$data$expt_aim,
                   expt_gen = jd$answers$data$expt_gen)
  
     d <- bind_rows(d, id)
}


# Number of participants
length(unique(d$workerid))

```

	
```{r data gathering and preparation}

############ Prepping Survey Responses for Analyses ####################################

#Making age and gender numeric and factor variables, respectively
#I'm sure I will have to clean this part up, but trying to keep moving forward
d$age <- as.numeric(d$age)
d$gender <- as.factor(d$gender)


#Setting stimulus variable as string
d$stimulus <- as.character(d$stimulus)



#generating a unique "accuracy" variable from stimulus for PVT practice and performance trials
#First as a string variable, including "dont know" and "not responded" as separate categories, then as a numeric binary, only including "accurate" as 1 and all else as 0. 

d1 <- d %>% 
    mutate(accuracy.string = ifelse(trial_type=="PVTpractice" | 
                             trial_type=="performance", 
                      rating_raw, NA)) %>% 
    mutate(accuracy = ifelse(accuracy.string=="accurate",
                            1, ifelse(accuracy.string=="inaccurate" |
                                        accuracy.string=="dontknow" |
                                        accuracy.string=="not responded",
                            0, NA)))

             

#Generating "pvt.acc" for accuracy on only the pvt performance trials (no practice)
d1 <- d1 %>% 
    mutate(pvt.acc = ifelse(trial_type=="performance",
                            accuracy, NA))

#Generating numeric ratings from the raw rating variable for the surveys
d2 <- d1 %>% 
    mutate(rating_2rev = ifelse(trial_type =="genAnx" |
                                trial_type == "mathAnx" |
                                trial_type == "mathMot", 
                      rating_raw, NA))
d2$rating_2rev <- as.numeric(d2$rating_2rev)

#Reverse scoring the 9 items from the general anxiety scale that need to be reversed
d3 <- d2 %>% 
      mutate(rating = ifelse(stimulus=='I feel pleasant.'|
                             stimulus=='I feel satisfied with myself.' |
                             stimulus=='I feel rested.' |
                             stimulus=='I am "calm, cool, and collected".' |
                             stimulus=='I am happy.' |
                             stimulus=='I feel secure.' |
                             stimulus=='I make decisions easily.' |
                             stimulus=='I am content.' |
                             stimulus=='I am a steady person.', 
                    (5 - rating_2rev), rating_2rev))
d <- d3

##########

### Math Motivation (3-item; see Chiu & Zeng, 2008) ######
d <- d %>% 
    mutate(mathmot = ifelse(trial_type =="mathMot",
                      rating, NA))


### Math Anxiety (30-item MARS-B; see Suinn & Winston, 2003) ###
  #No data prep needed aside from re-naming and calculating mean value for each participant, below
d <- d %>% 
    mutate(mathanx = ifelse(trial_type =="mathAnx",
                      rating, NA))

### General Anxiety (20-item (Trait Anxiety); see State-Trait Anxiety Inventory, Spielberger, 1983)
d <- d %>% 
    mutate(genanx = ifelse(trial_type =="genAnx",
                      rating, NA))


## Problem Verification Task (PVT) Performance  (see Rinne & Mazzocco, 2014) ####################


#The following analyses assume dataframe is called "d", reaction time of all PVT problems (in ms) is called "RT", accuracy (0 or 1) of each PVT problem is called "pvt.acc"

##Generating new RT variable to only include RTs for performance trials (probably unecessary, but playing it safe)

d <- d %>% 
  mutate(perf.RT = ifelse(trial_type=="performance",
                            RT, NA))



#Change reaction time (in ms) to reaction time in SECONDS
#Following method in Wang et al. (2015; see pg. 1866) 
d <- d %>% 
  mutate(sec.RT = perf.RT/1000)

####################################################################################


#### Mean Index and Standardized Scores for all measures #######
#str(d)
#Calculate mean 
subjectmeans <- d %>% 
  group_by(gender, age, workerid) %>% 
  summarise(mean.acc = mean(pvt.acc, na.rm=T), 
            mean.RT = mean(sec.RT, na.rm=T), 
            mean.mathmot = mean(mathmot, na.rm=T), 
            mean.mathanx = mean(mathanx, na.rm=T), 
            mean.genanx = mean(genanx, na.rm=T)) %>% 
  mutate(pvt = (mean.acc*100) / mean.RT)


 #Generate z-scores for variables (using "scale" function) 
subjectmeans$z.pvt <- scale(subjectmeans$pvt, center = TRUE, scale = TRUE)
subjectmeans$z.mathmot <- scale(subjectmeans$mean.mathmot, center = TRUE, scale = TRUE)
subjectmeans$z.mathanx <- scale(subjectmeans$mean.mathanx, center = TRUE, scale = TRUE)
subjectmeans$z.genanx <- scale(subjectmeans$mean.genanx, center = TRUE, scale = TRUE)


```

#### Confirmatory analysis
	The analyses as specified in the analysis plan
	
	
```{r CORRELATIONS between variables of interest, eval=FALSE}

##NOTE -- this correlation chunk is not being evaluated yet because need at least 4 data points to run

#Script for generating clean correlation table (bottom triangle only) with significance stars
corstarsl <- function(x){ 
require(Hmisc) 
x <- as.matrix(x) 
R <- rcorr(x)$r 
p <- rcorr(x)$P 

## define notions for significance levels; spacing is important.
mystars <- ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "* ", " ")))

## trunctuate the matrix that holds the correlations to two decimal
R <- format(round(cbind(rep(-1.11, ncol(x)), R), 2))[,-1] 

## build a new matrix that includes the correlations with their apropriate stars 
Rnew <- matrix(paste(R, mystars, sep=""), ncol=ncol(x)) 
diag(Rnew) <- paste(diag(R), " ", sep="") 
rownames(Rnew) <- colnames(x) 
colnames(Rnew) <- paste(colnames(x), "", sep="") 

## remove upper triangle
Rnew <- as.matrix(Rnew)
Rnew[upper.tri(Rnew, diag = TRUE)] <- ""
Rnew <- as.data.frame(Rnew) 

## remove last column and return the matrix (which is now a data frame)
Rnew <- cbind(Rnew[1:length(Rnew)-1])
return(Rnew) 
} 

##Create table from dataframe: 
cor_table <- corstarsl(subjectmeans) 

##To remove unwanted columns from dataframe before adding to correlation table (in order to replicate table from original study)

cor.means <- subjectmeans %>% 
  select(age, gender, mean.genanx, mean.mathanx, mean.mathmot, pvt)
##Create table from dataframe: 
cor_table <- corstarsl(cor.means)


## exporting tables to html, if desired: 
#print.xtable(cor_table, type="html", file="filename.html")



```

```{r Hierarchical Regression Models }

#General Linear Models for Hierarchical Regression of Anxiety and Motivation on Performance 

mathperflm0 <- lm(z.pvt ~ gender + z.genanx , data = subjectmeans)

kable(summary(mathperflm0)$coef)


mathperflm02 <- lm(z.pvt ~ gender + z.mathanx + z.mathmot, data = subjectmeans)

kable(summary(mathperflm02)$coef)


mathperflm1 <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2), data = subjectmeans)

kable(summary(mathperflm1)$coef)


mathperflm2 <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx + z.mathmot, data = subjectmeans)

kable(summary(mathperflm2)$coef)


mathperflm3 <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx + z.mathmot + I(z.mathanx^2) + z.mathanx * z.mathmot, data = subjectmeans)

kable(summary(mathperflm3)$coef)


mathperflm4 <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx * z.mathmot + (I(z.mathanx^2) * z.mathmot), data = subjectmeans)

summary(mathperflm4)$coef

kable(summary(mathperflm4)$coef)


##Alternatively, if the interaction terms don't already include those variables in the model
mathperflm4.alt <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx + z.mathmot + I(z.mathanx^2) + (z.mathanx * z.mathmot) + (I(z.mathanx^2) * z.mathmot), data = subjectmeans)

kable(summary(mathperflm4.alt)$coef)


```

```{r basic plot of predicted values}

ggplot(subjectmeans, aes(x = z.mathanx, y = z.pvt)) + 
  geom_point() +
  geom_smooth(method = lm, data = mathperflm4) +
  xlab("Math Anxiety") +
  ylab("PVT Efficiency Performance") +
  ggtitle("Math Performance on Math Anxiety") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))


```

```{r model at different SDs}

## NOTE that both of these models are giving the same result b/c there is not (apparent) variation across math motivation according to the model

##Minus-1  gives  1 SD ABOVE b/c you are shifting the x axis "to the right" (mean becomes -1)

mathperflm4_above <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx * I(z.mathmot - 1) + (I(z.mathanx^2) * I(z.mathmot - 1)), data = subjectmeans)

kable(summary(mathperflm4_above)$coef)



mathperflm4_below <- lm(z.pvt ~ age + gender + z.genanx + I(z.genanx^2) + z.mathanx * I(z.mathmot + 1) + (I(z.mathanx^2) * I(z.mathmot + 1)), data = subjectmeans)

kable(summary(mathperflm4_below)$coef)

```

```{r plot of model at different motivation SDs}

##ggplot of two predicted lines: for 
ggplot(subjectmeans, aes(x = z.mathanx, y = z.pvt)) + 
  geom_smooth(method = lm, data = mathperflm4_above) +
  geom_smooth(method = lm, data = mathperflm4_below) +
  xlab("Math Anxiety (Standardized)") +
  ylab("PVT Efficiency Performance (Standardized)") +
  ggtitle("Predicted PVT performance as function of anxiety and motivation") + 
    theme(plot.title = element_text(lineheight=.8, face="bold"))


```


#### Exploratory analyses

Will be conducting exploratory analyses on effect of education level, current student status, and whether or not participant has school-aged children on math performance, both independent of an in conjunction with math anxiety and math motivation. 

#####Discussion

######Summary of Replication Attempt
Open the discussion section with a paragraph summarizing the primary result from the confirmatory analysis and the assessment of whether it replicated, partially replicated, or failed to replicate the original result.  

######Commentary
Add open-ended commentary (if any) reflecting (a) insights from follow-up exploratory analysis, (b) assessment of the meaning of the replication (or not) - e.g., for a failure to replicate, are the differences between original and present study ones that definitely, plausibly, or are unlikely to have been moderators of the result, and (c) discussion of any objections or challenges raised by the current and original authors about the replication attempt.  None of these need to be long.

